&НаКлиенте
Перем фЗаблокироватьВызовСервера;

// ::::::::::::: ::::::::::::: :::::::::::::: ::::::::::::::::::: :::::::::::::: :::::::::::
// ФУНКЦИИ КОММЕНТИРОВАНИЯ

&НаКлиенте
Процедура ПоказатьКомментарии(Команда)
	клОбновитьОписание();
КонецПроцедуры

&НаКлиенте
Процедура клОбновитьОписание()
	Если фЗаблокироватьВызовСервера Тогда
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект.СсылкаНаЗадачу) Тогда
		ПолеИстории = КомментарииСервер.ПолучитьОписание(Объект.СсылкаНаЗадачу);
	Иначе
		ПолеИстории = КомментарииСервер.ПолучитьОписание(Объект.Ссылка);
	КонецЕсли;
КонецПроцедуры // клОбновитьОписание()

&НаКлиенте
Процедура СменитьСтатусПоручения(текДело = Неопределено)
	если объект.Ссылка.Пустая() тогда
		Возврат;
	конецесли;
	
	КомментарийДела = СтрЗаменить(ПолеКомментария, Символы.ПС, "<br>");
	ПолеКомментария = "";
	
	Если ЗначениеЗаполнено(Объект.СсылкаНаЗадачу) Тогда
		КомментарииКлиент.УстановитьСтатусПоручения(Объект.СсылкаНаЗадачу, КомментарийДела);
	Иначе
		КомментарииКлиент.УстановитьСтатусПоручения(Объект.Ссылка, КомментарийДела);
	КонецЕсли;
	
	клОбновитьОписание();
КонецПроцедуры // СменитьСтатусПоручения()

&НаКлиенте
Процедура ДобавитьКомментарий(Команда)
	СменитьСтатусПоручения();
КонецПроцедуры

&НаКлиенте
Процедура СсылкаДобавитьКомментарийНажатие(Элемент)
	текПозиция = Элементы.ПанельДобавленияКомментария.Видимость;
	
	Элементы.ПанельДобавленияКомментария.Видимость = НЕ текПозиция;
	Если текПозиция Тогда // панель видима, и мы переходим в режим не видимости
		Элементы.СсылкаДобавитьКомментарий.Заголовок = "Оставить комментарий";
	Иначе
		Элементы.СсылкаДобавитьКомментарий.Заголовок = "Скрыть поле добавления комментария";
	КонецЕсли;
КонецПроцедуры

// ::::::::::::: ::::::::::::: :::::::::::::: ::::::::::::::::::: :::::::::::::: :::::::::::

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	фЗаблокироватьВызовСервера = Ложь;
	
	ПоказатьКомментарии(Неопределено);
	
	ПодключитьОбработчикОжидания("клОбновитьОписание", 15);
КонецПроцедуры

&НаКлиенте
Процедура НаименованиеПриИзменении(Элемент)
	фЗаблокироватьВызовСервера = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура НаименованиеАвтоПодбор(Элемент, Текст, ДанныеВыбора, Ожидание, СтандартнаяОбработка)
	фЗаблокироватьВызовСервера = Истина;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если ЗначениеЗаполнено(Параметры.Основание) Тогда
		Объект.СсылкаНаЗадачу = Параметры.Основание;
		
		Объект.Наименование = Параметры.Основание;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриЗаписиНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	Если ТекущийОбъект.ДополнительныеСвойства.Свойство("ЭтоНовый") И ТекущийОбъект.ДополнительныеСвойства.ЭтоНовый Тогда
		МодульДел.ОбновитьЗначениеВРегистре("ЗадачиКПожеланию", "Дело", ТекущийОбъект.СсылкаНаЗадачу, "Статус", ПредопределенноеЗначение("Перечисление.Статус.ВРаботе"), , Ложь);
	КонецЕсли;
КонецПроцедуры


&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	ТекущийОбъект.ДополнительныеСвойства.Вставить("ЭтоНовый", ТекущийОбъект.ЭтоНовый());
КонецПроцедуры

